å½“ç„¶ï¼Œä»¥ä¸‹æ˜¯ä¸€ä»½**å®Œæ•´æ¸…æ™°çš„ä¸­é—´ä»¶ç”Ÿæˆè¯·æ±‚è¯´æ˜**ï¼Œä½ å¯ä»¥æäº¤è¿™ä»½è¯´æ˜ç»™ ChatGPTï¼Œä»¥å¿«é€Ÿã€é«˜è´¨é‡åœ°ç”Ÿæˆé€‚ç”¨äº Tony é¡¹ç›®çš„ä¸­é—´ä»¶ï¼š

---

## ğŸ§© ä¸­é—´ä»¶ç”Ÿæˆè¯·æ±‚ï¼šä¸º Tony é¡¹ç›®ç”Ÿæˆä¸­é—´ä»¶

### ğŸ§± é¡¹ç›®èƒŒæ™¯

Tony æ˜¯ä¸€ä¸ª**æç®€æ— æ¡†æ¶çš„ Node.js Web æœåŠ¡æ–¹æ¡ˆ**ï¼Œå¼ºè°ƒï¼š

* **æ¨¡å—æ˜¾å¼åŠ è½½**ï¼Œä¸åšè‡ªåŠ¨æ‰«ææˆ–ä¾èµ–æ³¨å…¥
* **ä¸ä½¿ç”¨ Expressã€Koa ç­‰æ¡†æ¶**
* **ä¸ä½¿ç”¨ä¸­é—´ä»¶é“¾å¼è°ƒç”¨æœºåˆ¶**ï¼Œè€Œæ˜¯æŒ‰é¡ºåºæ˜¾å¼è°ƒç”¨ä¸­é—´ä»¶ä¸è·¯ç”±å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š

```js
await log(req, res)
await cookies(req, res)
await session(req, res)!
await _home(req, res)!
await _error(req, res)!
```

### ğŸ”§ ä¸­é—´ä»¶è§„èŒƒ

ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œå¯¼å‡ºä¸€ä¸ª async å‡½æ•°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```js
export default async function middleware(req, res) {
  // å¦‚æœå¤„ç†å®Œè¯·æ±‚
  res.writeHead(200)
  res.end("Handled")
  return false;

  // æˆ–è€…ç»§ç»­ä¸‹ä¸€ä¸ªå¤„ç†
  return true;
}
```

### ğŸ”— ä¸­é—´ä»¶è¡Œä¸ºè§„åˆ™

* è¿”å› `false`ï¼šè¡¨ç¤ºè¯¥ä¸­é—´ä»¶å·²**ç»ˆç»“å“åº”æµç¨‹**ï¼ˆä¾‹å¦‚è¿”å› 401ã€è¾“å‡ºé™æ€èµ„æºç­‰ï¼‰
* è¿”å› `true`ï¼šè¡¨ç¤º**ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±**
* å¯åœ¨ `req` ä¸Šæ‰©å±•å±æ€§ï¼ˆå¦‚ `req.user`, `req.cookies`, `req.body` ç­‰ï¼‰

### ğŸ“¦ é¡¹ç›®ç»“æ„

Tony é¡¹ç›®çš„ä¸­é—´ä»¶ç»Ÿä¸€å­˜æ”¾åœ¨ `middlewares/` ç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œä¾‹å¦‚ï¼š

```
middlewares/
  log.js
  cookies.js
  auth.js
```

ä½¿ç”¨æ–¹å¼ï¼š

```js
import log from './middlewares/log.js';
await log(req, res)!
```

---

### âœ… è¯·æ ¹æ®ä»¥ä¸‹è¾“å…¥ç”Ÿæˆä¸­é—´ä»¶

> * åŠŸèƒ½ï¼šâ“ï¼ˆè¯·å¡«å†™ï¼Œå¦‚ï¼šè§£æ Cookie / æ ¡éªŒ JWT / è®°å½•æ—¥å¿—ï¼‰
> * æ˜¯å¦éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼šâ“ï¼ˆå¦‚ `jsonwebtoken`, `cookie`, `uuid` ç­‰ï¼‰
> * æ˜¯å¦éœ€è¦è¯»å–/å†™å…¥ `req` æˆ– `res` ä¸Šä¸‹æ–‡ï¼šâ“
> * æ˜¯å¦éœ€è¦é…ç½®é¡¹ï¼šâ“ï¼ˆå¦‚é™åˆ¶é¢‘ç‡ã€token è¿‡æœŸæ—¶é—´ï¼‰
> * ä¸­é—´ä»¶æ–‡ä»¶åå»ºè®®ä¸ºï¼š`middlewares/xxx.js`
> * ç¼–å†™ä¸º ES6 æ¨¡å—è¯­æ³•ï¼ˆ`export default`ï¼‰

---

ä½ åªéœ€è¦å¡«å†™ â“ çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š

> * åŠŸèƒ½ï¼šä» Cookie è§£æ session ID å¹¶æŒ‚è½½ req.session
> * æ˜¯å¦éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼šéœ€è¦ `cookie`
> * æ˜¯å¦éœ€è¦è¯»å–/å†™å…¥ req æˆ– res ä¸Šä¸‹æ–‡ï¼šæ˜¯ï¼Œéœ€è¦å†™å…¥ req.session
> * æ˜¯å¦éœ€è¦é…ç½®é¡¹ï¼šä¸éœ€è¦
> * æ–‡ä»¶åå»ºè®®ä¸ºï¼š`middlewares/session.js`

